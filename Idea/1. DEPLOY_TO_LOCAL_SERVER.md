docker compose -f docker-compose.prod.yml stop api
docker compose -f docker-compose.prod.yml exec db psql -U postgres -c "DROP DATABASE IF EXISTS task_manager;"
docker compose -f docker-compose.prod.yml exec db psql -U postgres -c "CREATE DATABASE task_manager;"
docker compose -f docker-compose.prod.yml build
docker compose -f docker-compose.prod.yml up -d
docker compose -f docker-compose.prod.yml run --rm api npx prisma migrate deploy
docker compose -f docker-compose.prod.yml logs -f
docker compose -f docker-compose.prod.yml down
# Hướng Dẫn Triển Khai Project Jiraboard Trên Ubuntu Server

Tập tin này là bản hướng dẫn chuyên biệt cho `Ubuntu Server` (không GUI). Mục tiêu: chạy bằng Docker Compose, an toàn cho môi trường local/private server hoặc VPS.

## 1) Yêu cầu trước
- Hệ điều hành: **Ubuntu Server LTS** (ví dụ `22.04` hoặc `24.04`).
- Phần mềm: `docker`, `docker-compose` (plugin Compose V2), `git`.
- Mở port: `22` (SSH), `80` (HTTP), `443` (HTTPS). Port DB `5432` chỉ mở nội bộ nếu cần.

## 2) Cài Docker & Docker Compose (Ubuntu)
Chạy trên server (SSH):

```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y ca-certificates curl gnupg lsb-release
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmour -o /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" |
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
sudo usermod -aG docker $USER
# Đăng xuất / đăng nhập lại để nhóm docker có hiệu lực, hoặc chạy: newgrp docker

docker --version
docker compose version
```

## 3) Tạo user & thư mục triển khai

```bash
sudo mkdir -p /opt/jiraboard
sudo chown $USER:$USER /opt/jiraboard
cd /opt/jiraboard
```

## 4) Clone repo (hoặc pull images nếu dùng registry)

```bash
git clone https://github.com/<your-user>/Jiraboard.git .
# hoặc, nếu dùng private registry, skip clone và pull image later
```

## 5) Cấu hình biến môi trường
- Copy mẫu `.env` từ `server/.env` rồi chỉnh sửa giá trị phù hợp:

```bash
cp server/.env .env
nano .env
```

- Các biến quan trọng:
  - `DATABASE_URL` (ví dụ: `postgres://postgres:password@db:5432/task_manager`)
  - `JWT_SECRET` (tạo chuỗi dài, random)
  - `CORS_ORIGIN`, `VITE_API_URL` (URL frontend/backend)

Tạo `JWT_SECRET` nhanh:

```bash
openssl rand -base64 32
```

## 6) Chạy ứng dụng bằng Docker Compose
- Dùng file `docker-compose.prod.yml` trong repo.

```bash
# Build và chạy
docker compose -f docker-compose.prod.yml build
docker compose -f docker-compose.prod.yml up -d

# Kiểm tra
docker compose -f docker-compose.prod.yml ps
docker compose -f docker-compose.prod.yml logs -f api
```

## 7) Tự động Start bằng systemd (suggested)
Tạo một đơn vị systemd để đảm bảo Compose auto-start nếu reboot.

Tạo file `/etc/systemd/system/jiraboard.service` (chạy bằng sudo):

```ini
[Unit]
Description=Jiraboard Docker Compose
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/jiraboard
ExecStart=/usr/bin/docker compose -f docker-compose.prod.yml up -d
ExecStop=/usr/bin/docker compose -f docker-compose.prod.yml down

[Install]
WantedBy=multi-user.target
```

Đăng ký và khởi động:

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now jiraboard.service
sudo systemctl status jiraboard.service
```

## 8) Chạy migrations (Prisma)

```bash
docker compose -f docker-compose.prod.yml run --rm api npx prisma migrate deploy
```

## 9) Import / Export database
- Export trên máy dev:

```bash
pg_dump -U postgres -h <host> -Fc -f dump.sql task_manager
```

- Import vào container (server):

```bash
# Stop API để tránh giữ kết nối
docker compose -f docker-compose.prod.yml stop api

# Drop và tạo lại DB
docker compose -f docker-compose.prod.yml exec db psql -U postgres -c "DROP DATABASE IF EXISTS task_manager;"
docker compose -f docker-compose.prod.yml exec db psql -U postgres -c "CREATE DATABASE task_manager;"

# Import (trong server):
docker compose -f docker-compose.prod.yml exec -T db pg_restore -U postgres -d task_manager < /path/to/dump.sql
```

Ghi chú: trên Ubuntu, `pg_restore` dùng với dump định dạng `-Fc`.

## 10) Reverse proxy & TLS (nginx)
- Nếu dịch vụ public, đặt nginx (container hoặc host) để reverse-proxy và cấp TLS với Let's Encrypt.
- Ví dụ nhanh (nginx host + certbot):

```bash
sudo apt install -y nginx certbot python3-certbot-nginx
sudo ufw allow 'Nginx Full'
sudo certbot --nginx -d your-domain.com
```

Hoặc dùng Traefik container nếu muốn quản lý nhiều dịch vụ.

## 11) Bảo mật & vận hành
- **SSH keys:** dùng key-based auth, tắt password auth.
- **UFW:** bật firewall, mở chỉ các port cần thiết:

```bash
sudo apt install -y ufw
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow OpenSSH
sudo ufw allow http
sudo ufw allow https
sudo ufw enable
```

- **Fail2ban** để bảo vệ SSH.
- **Backup DB:** lên lịch `pg_dump` hoặc dùng `pg_basebackup` rồi lưu vào host/remote.
- **Docker volumes:** mount volumes ra host để lưu dữ liệu Postgres an toàn.

## 12) Lệnh hữu ích nhanh

```bash
# Xem logs
docker compose -f docker-compose.prod.yml logs -f

# Restart service
sudo systemctl restart jiraboard.service

# Chạy migration
docker compose -f docker-compose.prod.yml run --rm api npx prisma migrate deploy

# Stop everything
docker compose -f docker-compose.prod.yml down
```

## 13) Gợi ý vận hành và CI/CD
- Tốt nhất: build/push image lên private registry (GHCR/Docker Hub private) và cấu hình `docker-compose.prod.yml` dùng `image:` để pull. Điều này tách bước build khỏi máy chủ.
- Có thể dùng GitHub Actions để build/push image và (tùy chọn) trigger webhook trên server để `docker compose pull && docker compose up -d`.

## Kết luận / Next steps
- Hướng dẫn này đã tối ưu cho `Ubuntu Server` (CLI-first). Nếu bạn muốn, tôi có thể:
  - Tạo script bash `deploy.sh` (clone, env, build, up, migrate, systemd) để chạy 1 lệnh.
  - Viết vignette `nginx + certbot` chi tiết cho domain cụ thể.
  - Viết GitHub Actions workflow mẫu để build và push images.

Cho mình biết bạn muốn tự động hoá phần nào — mình sẽ tạo script/CI tương ứng.
