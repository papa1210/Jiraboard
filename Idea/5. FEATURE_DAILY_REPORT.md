# Daily Report – Preview, Generate, Export (Excel)

## Yêu cầu chức năng
- Có giao diện preview daily report trước khi xuất file.
- Nút **Generate Daily Report**: khi nhấn sẽ tự động tạo report và cập nhật mảng `Nextday_task`.
- Cần 2 mảng: `Report_task` và `Nextday_task`.
- `Nextday_task[ngày i+1]` gồm toàn bộ task trong cột In Progress tại thời điểm nhấn Generate.
- `Report_task[ngày i]` = `Nextday_task[ngày i]` + các task đang In Progress nhưng chưa có trong `Nextday_task[ngày i]` (tức các task mới kéo từ To Do sang In Progress trong ngày).
- Ví dụ: Generate ngày 02/12/2025 → `Report_task[02/12/2025]` = `Nextday_task[02/12/2025]` + các task In Progress không có trong `Nextday_task[02/12/2025]`; sau đó `Nextday_task[03/12/2025]` = toàn bộ task In Progress hiện tại.
- Định dạng export: Excel (.xlsx).

## Format báo cáo
- Header: “Báo cáo ngày Today()”.
- Personnel: cột STT, Personnel Name (user ON DUTY), Title (ON DUTY), Assignment (site ON DUTY: PQP-HT hoặc MT1).

### Activities Last 24 Hours (dữ liệu từ `Report_task`)
- Cột: STT; Date = ngày lập báo cáo; Platform = trống; WO = TaskID; PTW = trống; Activities Last 24 Hours = task description; RESULT = Completion %; PIC = danh sách assigned resources (On Duty).

### Activities Looking Ahead (dữ liệu từ `Nextday_task`)
- Cột: STT; Date = ngày lập báo cáo; Platform = trống; WO = TaskID; PTW = trống; Activities Looking Ahead = các task In Progress sau 17h00 của ngày lập báo cáo (dùng snapshot next-day); RESULT = Completion %; PIC = assigned resources (On Duty).

## Đề xuất triển khai (Daily Report)
1) Dữ liệu & logic `Report_task` / `Nextday_task`  
   - Generate ngày D:  
     - `Nextday_task[D+1]`: snapshot toàn bộ task In Progress lúc bấm (id, title, description, completion%, assignedResourceIds).  
     - `Report_task[D]`: `Nextday_task[D]` (hôm trước) + In Progress hiện tại \ `Nextday_task[D]`.  
   - Lưu snapshot DB: bảng `DailyReportSnapshot` (date, reportTasks JSON, nextdayTasks JSON, generatedBy, generatedAt).  
   - Khi generate: đọc snapshot hôm trước để lấy `Nextday_task[D]`; nếu chưa có thì rỗng. Tính `Report_task[D]` và lưu `Nextday_task[D+1]`.  
   - Nguồn dữ liệu: Task (id, title/description, completionPercent, assignedResourceIds, status); Resource (user ON DUTY, role/title, site). PIC = assignedResourceIds giao với ON_DUTY.

2) UI/UX trang Daily Report  
   - Ô chọn ngày (default hôm nay) + nút Generate.  
   - Preview gồm:  
     - Personnel (ON DUTY): STT, Name, Title, Assignment (site).  
     - Activities Last 24 Hours: từ `Report_task[D]`.  
     - Activities Looking Ahead: từ `Nextday_task[D+1]`.  
   - Nút Export Excel dùng dữ liệu snapshot (không phụ thuộc state UI sau đó).

3) Backend endpoints  
   - `POST /reports/daily/generate` body `{ date?: YYYY-MM-DD }`:  
     - Lấy snapshot hôm trước (`Nextday_task[D]`).  
     - `Report_task[D]` = `Nextday_task[D]` + In Progress hiện tại \ `Nextday_task[D]`.  
     - `Nextday_task[D+1]` = In Progress hiện tại.  
     - Lưu vào `DailyReportSnapshot`; trả snapshot để frontend preview.  
   - `GET /reports/daily?date=YYYY-MM-DD`: trả snapshot (reportTasks, nextdayTasks, generatedBy/At).  
   - (Tùy chọn) `GET /reports/daily/export?date=...` trả file xlsx; hoặc frontend tự export.

4) Export Excel (frontend)  
   - Dùng snapshot từ API → tạo workbook:  
     - Header: “Báo cáo ngày <D>”, exportedAt, exportedBy.  
     - Sheet Personnel.  
     - Sheet Activities Last 24 Hours.  
     - Sheet Activities Looking Ahead.  
   - Thư viện: sheetjs/xlsx hoặc ExcelJS (frontend).

5) Scope cho “Looking Ahead”  
   - Dùng `Nextday_task[D+1]` (snapshot khi generate). Nếu cần cứng 17h, có thể filter In Progress tại mốc 17:00.

6) Các bước thực hiện  
   - Thêm model `DailyReportSnapshot` (date, reportTasks jsonb, nextdayTasks jsonb, generatedById, generatedAt).  
   - Thêm API generate/get như trên.  
   - Trang `/reports/daily`: UI preview + Generate + Export; lấy data từ snapshot.  
   - Export xlsx từ snapshot.
