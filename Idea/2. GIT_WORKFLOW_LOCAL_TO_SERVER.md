# Hướng Dẫn Git Workflow: Code Local → Git → Server Auto-Pull & Deploy

File này hướng dẫn mô hình phát triển an toàn và khuyến nghị nhất:
- **Máy dev (local):** Code, test, commit, push git.
- **Server (Ubuntu):** Pull từ git, chạy deploy script tự động.
- **Git server:** GitHub (hoặc GitLab, Gitea).

---

## 1) Lợi ích của mô hình này

- ✅ **Tách biệt môi trường:** Code ≠ Server, giảm rủi ro.
- ✅ **Version control rõ ràng:** Mọi thay đổi lưu lại git, dễ rollback.
- ✅ **Tự động triển khai:** Cron hoặc webhook tự pull + deploy.
- ✅ **CI/CD dễ dàng:** GitHub Actions xây dựng image tự động.
- ✅ **Multi-server ready:** Deploy cùng lúc tới nhiều server.
- ✅ **Bảo mật:** Server không cần SSH mở rộng, chỉ pull từ git.

---

## 2) Cấu trúc workflow

```
Dev Machine (Local)
  ↓
  [Code] → [Test] → [Commit] → [Push to GitHub]
                                      ↓
                              GitHub Repository
                                      ↓
                    ┌─────────────────────────────┐
                    ↓                             ↓
            GitHub Actions            Server (Ubuntu)
            (Build & Push                 ↓
             Docker Images)         [Git Pull] →
                    ↓                 [Deploy Script]
              Docker Registry              ↓
              (GHCR/Docker Hub)      [Compose Up/Migrate]
                    ↓
              [Pull by Server]
```

---

## 3) Lần đầu thiết lập Server

### 3.1) Chuẩn bị máy Ubuntu Server
```bash
# SSH vào server
ssh user@server-ip

# Cập nhật hệ thống
sudo apt update && sudo apt upgrade -y

# Cài Docker & Docker Compose (xem hướng dẫn DEPLOY_TO_LOCAL_SERVER.md)
# ... (skip nếu đã cài)
```

### 3.2) Clone repo vào server
```bash
# Tạo thư mục triển khai
sudo mkdir -p /opt/jiraboard
sudo chown $USER:$USER /opt/jiraboard
cd /opt/jiraboard

# Clone repo (dùng HTTPS nếu không có SSH key cho GitHub)
git clone https://github.com/<your-user>/Jiraboard.git .
# Hoặc SSH (nếu setup SSH key):
# git clone git@github.com:<your-user>/Jiraboard.git .

# Kiểm tra remote
git remote -v
# Kết quả:
# origin  https://github.com/<your-user>/Jiraboard.git (fetch)
# origin  https://github.com/<your-user>/Jiraboard.git (push)
```

### 3.3) Thiết lập .env trên server
```bash
# Tạo .env từ server/.env
cp server/.env .env

# Chỉnh sửa (dùng nano hoặc vim)
nano .env
```

Các biến quan trọng:
```properties
DATABASE_URL="postgres://postgres:password@db:5432/task_manager"
JWT_SECRET="<generate-with-openssl-rand-base64-32>"
CORS_ORIGIN="http://your-domain.com"
VITE_API_URL="http://your-domain.com"
PORT=4000
```

### 3.4) Cài systemd service
```bash
# Copy systemd unit template từ repo vào /etc/systemd/system
sudo cp scripts/jiraboard.service /etc/systemd/system/jiraboard.service

# Đăng ký & bật service
sudo systemctl daemon-reload
sudo systemctl enable jiraboard.service

# Thử khởi động 1 lần (chưa cần deploy lần đầu, chỉ kiểm tra cấu trúc)
# sudo systemctl start jiraboard.service
```

---

## 4) Workflow hàng ngày: Code local

### 4.1) Trên máy dev (local)
```bash
# Tạo feature branch
git checkout -b feature/my-feature

# Code, test, commit
git add .
git commit -m "feat: add new feature"

# Push lên GitHub
git push origin feature/my-feature
```

### 4.2) Tạo Pull Request (optional nhưng khuyến nghị)
- Trên GitHub: tạo PR từ `feature/my-feature` vào `main`.
- Review, test, merge vào `main`.

### 4.3) Server tự động pull & deploy

**Option A: Cron polling (đơn giản, không cần webhook)**

Tạo cron job để check git mỗi 5 phút:

```bash
# Tạo script auto-pull
cat > /opt/jiraboard/scripts/auto-pull.sh << 'EOF'
#!/usr/bin/env bash
set -euo pipefail

WORKDIR="/opt/jiraboard"
cd "$WORKDIR"

# Lưu commit hiện tại
OLD_COMMIT=$(git rev-parse HEAD)

# Pull từ origin main
git fetch origin main
NEW_COMMIT=$(git rev-parse origin/main)

# Nếu có thay đổi, chạy deploy
if [[ "$OLD_COMMIT" != "$NEW_COMMIT" ]]; then
  echo "New commits found. Deploying..."
  git reset --hard origin/main
  ./scripts/deploy.sh pull
else
  echo "No new commits. Skipping deploy."
fi
EOF

chmod +x /opt/jiraboard/scripts/auto-pull.sh
```

Thêm cron job:
```bash
# Mở crontab
sudo crontab -e

# Thêm dòng này (chạy mỗi 5 phút):
*/5 * * * * /opt/jiraboard/scripts/auto-pull.sh >> /var/log/jiraboard-auto-pull.log 2>&1
```

Kiểm tra log:
```bash
tail -f /var/log/jiraboard-auto-pull.log
```

---

**Option B: GitHub Webhook (tự động ngay, không chờ cron)**

### 4.4) Webhook receiver trên server (simple bash)

Tạo một script nhỏ để lắng nghe POST từ GitHub:

```bash
cat > /opt/jiraboard/scripts/webhook-receiver.sh << 'EOF'
#!/usr/bin/env bash
# Simple webhook receiver - lắng nghe POST từ GitHub
# Chạy dưới một service nhỏ hoặc systemd socket

WORKDIR="/opt/jiraboard"
WEBHOOK_SECRET="${WEBHOOK_SECRET:-}" # đặt trong .env hoặc system

cd "$WORKDIR"

# Đơn giản: chỉ pull & deploy nếu nhận request
echo "Webhook triggered. Pulling and deploying..."

git fetch origin main
git reset --hard origin/main
./scripts/deploy.sh pull

echo "Deploy completed at $(date)"
EOF

chmod +x /opt/jiraboard/scripts/webhook-receiver.sh
```

Tạo systemd service nhỏ để chạy HTTP listener (dùng socat hoặc node):

**Mẫu systemd webhook service (bash + socat):**
```ini
# /etc/systemd/system/jiraboard-webhook.service
[Unit]
Description=Jiraboard Webhook Listener
After=network.target

[Service]
Type=simple
WorkingDirectory=/opt/jiraboard
ExecStart=/bin/bash -c 'while true; do echo -e "HTTP/1.1 200 OK\r\nContent-Length: 2\r\n\r\nOK" | nc -l -p 9090 -q 1; /opt/jiraboard/scripts/webhook-receiver.sh; done'
Restart=always
User=ubuntu

[Install]
WantedBy=multi-user.target
```

Hoặc đơn giản hơn, dùng **GitHub Push event** + script trong cron (Option A).

### 4.5) Cấu hình GitHub webhook (nếu chọn Option B)

Trên GitHub repo:
1. Settings → Webhooks → Add webhook.
2. Payload URL: `http://<server-ip>:9090/webhook`
3. Content type: `application/json`.
4. Events: `Push events`.
5. Save.

Khi push vào `main`, GitHub sẽ gửi POST → server nhận → chạy deploy script.

---

## 5) Quy trình deploy chi tiết

### 5.1) deploy.sh hoạt động như thế nào
```bash
# (1) Check docker
# (2) Stop systemd service (nếu cần)
# (3) Docker compose down
# (4) Docker compose pull (hoặc build)
# (5) Docker compose up -d
# (6) Chờ 5 giây DB sẵn sàng
# (7) Chạy prisma migrate deploy
# (8) Kích hoạt systemd jiraboard.service
# (9) Hiển thị logs
```

### 5.2) Các lệnh hữu ích trên server
```bash
# Xem status
docker compose -f docker-compose.prod.yml ps

# Xem logs
docker compose -f docker-compose.prod.yml logs -f api

# Restart service
sudo systemctl restart jiraboard.service

# Kiểm tra systemd logs
sudo journalctl -u jiraboard.service -f

# Rollback (revert commit & deploy lại)
cd /opt/jiraboard
git log --oneline -5
git reset --hard <commit-hash>
./scripts/deploy.sh pull
```

---

## 6) Quản lý bảo mật

### 6.1) SSH key thay password
```bash
# Trên dev machine, tạo SSH key (nếu chưa có)
ssh-keygen -t ed25519 -C "your@email.com"

# Copy public key vào GitHub
# Settings → SSH and GPG keys → New SSH key
```

### 6.2) Dùng HTTPS + Personal Access Token (nếu không dùng SSH)
```bash
# Tạo PAT trên GitHub: Settings → Developer settings → Personal access tokens
# Chọn scope: repo, workflow

# Trên server, cấu hình git credential:
git config --global credential.helper store

# Lần đầu pull:
git pull origin main
# (nhập PAT thay password)

# Hoặc dùng .netrc:
cat > ~/.netrc << 'EOF'
machine github.com
login <username>
password <personal-access-token>
EOF
chmod 600 ~/.netrc
```

### 6.3) Giới hạn quyền .env
```bash
# Đảm bảo .env không được commit
echo ".env" >> .gitignore
git rm --cached .env

# Trên server, set quyền
chmod 600 /opt/jiraboard/.env
```

---

## 7) Backup trước deploy

**Khuyến nghị:** thêm backup vào `deploy.sh` hoặc cron.

```bash
# Backup DB trước migrate
BACKUP_DIR="/opt/jiraboard/backups"
mkdir -p "$BACKUP_DIR"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

docker compose -f docker-compose.prod.yml exec -T db pg_dump -U postgres task_manager \
  | gzip > "$BACKUP_DIR/backup_${TIMESTAMP}.sql.gz"

# Giữ 7 ngày backup gần nhất
find "$BACKUP_DIR" -name "backup_*.sql.gz" -mtime +7 -delete
```

---

## 8) Troubleshooting

| Vấn đề | Giải pháp |
|--------|-----------|
| **Git pull báo lỗi permission** | Kiểm tra SSH key hoặc PAT, cấp quyền folder |
| **Migrate fail, app không start** | Xem logs: `docker compose logs api` |
| **Webhook không trigger** | Kiểm tra GitHub webhook settings, xem "Recent Deliveries" |
| **Cron không chạy** | Kiểm tra: `sudo journalctl -u cron` hoặc `cat /var/log/jiraboard-auto-pull.log` |
| **Container port bị chiếm** | Thay port trong `.env` hoặc kill process khác: `sudo lsof -i :80` |

---

## 9) Dòng thời gian một deployment

```
14:00:00 Dev push commit lên main
14:00:05 GitHub Actions trigger (build image)
14:00:30 Images được push lên registry
14:05:00 Cron chạy auto-pull.sh trên server
14:05:10 Git pull mới commits
14:05:15 deploy.sh chạy: docker compose down → up → migrate
14:05:45 App ready tại http://server-ip
```

---

## 10) Cheat sheet

### Trên máy dev (local):
```bash
git checkout -b feature/my-feature
# Code...
git add .
git commit -m "feat: description"
git push origin feature/my-feature
# → Create PR & merge vào main (hoặc push trực tiếp nếu single developer)
```

### Trên server (Ubuntu):
```bash
# Cài lần đầu
sudo mkdir -p /opt/jiraboard && sudo chown $USER:$USER /opt/jiraboard
cd /opt/jiraboard
git clone https://github.com/<user>/Jiraboard.git .
cp server/.env .env
nano .env
sudo cp scripts/jiraboard.service /etc/systemd/system/
sudo systemctl daemon-reload && sudo systemctl enable jiraboard.service
sudo crontab -e
# → Thêm: */5 * * * * /opt/jiraboard/scripts/auto-pull.sh >> /var/log/jiraboard-auto-pull.log 2>&1

# Lần đầu deploy
./scripts/deploy.sh pull

# Theo dõi
docker compose -f docker-compose.prod.yml logs -f
sudo journalctl -u jiraboard.service -f
```

### Khi cần rollback:
```bash
cd /opt/jiraboard
git log --oneline -10
git reset --hard <old-commit>
./scripts/deploy.sh pull
```

---

## 11) Bước tiếp theo

- [ ] Đặt GitHub PAT (nếu dùng HTTPS) hoặc SSH key.
- [ ] Clone repo trên server vào `/opt/jiraboard`.
- [ ] Tạo `.env` với giá trị production.
- [ ] Copy systemd service vào `/etc/systemd/system/`.
- [ ] Cấu hình cron polling hoặc webhook.
- [ ] Chạy `./scripts/deploy.sh pull` lần đầu.
- [ ] Kiểm tra app chạy: `docker compose ps` & `curl http://localhost`.
- [ ] Test: Push commit từ dev → Kiểm tra server auto-pull & deploy.

---

## 12) Liên kết

- [DEPLOY_TO_LOCAL_SERVER.md](./DEPLOY_TO_LOCAL_SERVER.md) — Setup server ban đầu.
- `scripts/deploy.sh` — Deploy script chính.
- `scripts/auto-pull.sh` — Auto-pull helper.
- `scripts/jiraboard.service` — Systemd unit.
- `.github/workflows/ci-cd.yml` — GitHub Actions config.

---

**Lưu ý cuối:** Mô hình này an toàn, khả năng mở rộng, và phù hợp cho team. Nếu có thắc mắc hoặc muốn tinh chỉnh gì, hãy hỏi.
