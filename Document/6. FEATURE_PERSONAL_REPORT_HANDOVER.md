# Tính Năng Báo Cáo Cá Nhân (Handover Report)

**Mục đích:** Tạo báo cáo cá nhân để handover các task cho nhân sự back-to-back. Chỉ xuất task được assign cho user đang đăng nhập.

---

## 1) Yêu cầu chức năng

### 1.1) Giao diện & Navigation
- Card "Báo cáo cá nhân" trên trang Reports → chuyển thành nút dẫn tới trang báo cáo cá nhân.
- Trang báo cáo cá nhân (`/reports/personal`) có nút **Back** về trang report chính.
- Cho phép chọn giai đoạn (khoảng ngày) để báo cáo.

### 1.2) Dữ liệu & Lọc
- **Chỉ xuất task ứng với user đang login:**
  - Ví dụ: user `tungth` login → chỉ xuất task mà `tungth` được assign (task có `assignedResourceIds` chứa user ID hiện tại).
- **Khoảng thời gian:**
  - Cho phép chọn start date, end date (mặc định: tuần hiện tại).
  - Lọc task theo `startDate` hoặc `completionDate` (fallback `createdAt`).

### 1.3) Export File
- **Format:** Excel (XLSX) ưu tiên, hoặc CSV.
- **Các cột:** STT, TaskID, Task Description, Task Status, % Completion, Comment, Start Date, Completion Date.
- **Tiêu đề report:** "Handover report of `<username>` from `<start-date>` to `<end-date>`"

### 1.4) Preview & UX
- **Preview table** trước export: hiển thị dữ liệu sẽ xuất.
- Nút "Export" để sinh file.
- **Lưu trữ filter** trong localStorage để giữ lựa chọn khi F5 page.
- Loading/empty states khi không có data.

---

## 2) Code Proposal & Implementation Details

### 2.1) Bổ sung Current User ID vào DataContext

**File: `client/context/DataContext.tsx`**

Thêm `currentUserId` state:
```typescript
interface AppData {
  tasks: Task[];
  sprints: Sprint[];
  currentUserId?: string; // Thêm dòng này
  // ...
}

const DataContext = createContext<DataContextType | undefined>(undefined);

export const DataProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [data, setData] = useState<AppData>(() => {
    const saved = localStorage.getItem('appData');
    if (saved) {
      return JSON.parse(saved);
    }
    return {
      tasks: [],
      sprints: [],
      currentUserId: undefined, // Init
    };
  });

  // Expose currentUserId
  const value = {
    ...data,
    currentUserId: data.currentUserId,
    setCurrentUserId: (userId: string) => {
      setData(prev => ({ ...prev, currentUserId: userId }));
    },
  };

  // ... rest of context
};
```

**Lưu userId khi login** (trong API call auth):
```typescript
// Sau khi login thành công:
const { userId, token } = await loginAPI(email, password);
setCurrentUserId(userId);
localStorage.setItem('currentUserId', userId);
```

---

### 2.2) Trang Báo Cáo Cá Nhân (PersonalReportPage)

**File: `client/components/report/PersonalReportPage.tsx`**

```typescript
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useData } from '../../context/DataContext';
import Modal from '../ui/Modal';
import { Task, Status } from '../../types';
import * as XLSX from 'xlsx';

const PersonalReportPage: React.FC = () => {
  const navigate = useNavigate();
  const { tasks, currentUserId } = useData();

  const [startDate, setStartDate] = useState<string>(() => {
    const saved = localStorage.getItem('personalReportStartDate');
    if (saved) return saved;
    // Default: start of current week
    const today = new Date();
    const first = today.getDate() - today.getDay();
    return new Date(today.setDate(first)).toISOString().split('T')[0];
  });

  const [endDate, setEndDate] = useState<string>(() => {
    const saved = localStorage.getItem('personalReportEndDate');
    if (saved) return saved;
    // Default: end of current week
    const today = new Date();
    return today.toISOString().split('T')[0];
  });

  const [filteredTasks, setFilteredTasks] = useState<Task[]>([]);

  // Lọc task: user được assign + trong khoảng ngày
  useEffect(() => {
    if (!currentUserId) {
      setFilteredTasks([]);
      return;
    }

    const filtered = tasks.filter(task => {
      // Check nếu user được assign
      const assigned = task.assignedResourceIds?.includes(currentUserId);
      if (!assigned) return false;

      // Check khoảng ngày
      const taskDate = task.startDate || task.completionDate || task.createdAt;
      if (!taskDate) return false;

      const taskDateObj = new Date(taskDate);
      const start = new Date(startDate);
      const end = new Date(endDate);
      end.setHours(23, 59, 59, 999); // End of day

      return taskDateObj >= start && taskDateObj <= end;
    });

    setFilteredTasks(filtered.sort((a, b) => 
      new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime()
    ));
  }, [tasks, currentUserId, startDate, endDate]);

  // Lưu filter vào localStorage
  useEffect(() => {
    localStorage.setItem('personalReportStartDate', startDate);
    localStorage.setItem('personalReportEndDate', endDate);
  }, [startDate, endDate]);

  const handleExport = () => {
    if (filteredTasks.length === 0) {
      alert('Không có data để xuất');
      return;
    }

    // Tạo data for Excel
    const data = filteredTasks.map((task, index) => ({
      'STT': index + 1,
      'TaskID': task.taskId,
      'Task Description': task.description,
      'Task Status': task.status,
      '% Completion': task.completionPercentage || 0,
      'Comment': task.comments?.join(' | ') || '',
      'Start Date': task.startDate ? new Date(task.startDate).toLocaleDateString('vi-VN') : '',
      'Completion Date': task.completionDate ? new Date(task.completionDate).toLocaleDateString('vi-VN') : '',
    }));

    // Tạo workbook
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Handover Report');

    // Set column widths
    ws['!cols'] = [
      { wch: 5 },   // STT
      { wch: 12 },  // TaskID
      { wch: 30 },  // Description
      { wch: 12 },  // Status
      { wch: 12 },  // % Completion
      { wch: 25 },  // Comment
      { wch: 15 },  // Start Date
      { wch: 15 },  // Completion Date
    ];

    // Thêm title sheet
    const title = `Handover report of ${currentUserId} from ${startDate} to ${endDate}`;
    const titleSheet = XLSX.utils.aoa_to_sheet([[title]]);
    XLSX.utils.book_append_sheet(wb, titleSheet, 'Title');

    // Export
    XLSX.writeFile(wb, `HandoverReport_${currentUserId}_${startDate}_${endDate}.xlsx`);
  };

  if (!currentUserId) {
    return <div>Vui lòng đăng nhập trước.</div>;
  }

  return (
    <div style={{ padding: '20px' }}>
      <div style={{ marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <h1>Báo Cáo Cá Nhân (Handover)</h1>
        <button onClick={() => navigate('/reports')}>← Back to Reports</button>
      </div>

      {/* Filter */}
      <div style={{ marginBottom: '20px', padding: '10px', border: '1px solid #ddd', borderRadius: '4px' }}>
        <label>
          Start Date:
          <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} />
        </label>
        <label style={{ marginLeft: '20px' }}>
          End Date:
          <input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} />
        </label>
      </div>

      {/* Preview Table */}
      <div style={{ marginBottom: '20px' }}>
        <h3>Preview ({filteredTasks.length} tasks)</h3>
        {filteredTasks.length === 0 ? (
          <p>No tasks found for the selected period.</p>
        ) : (
          <div style={{ overflowX: 'auto' }}>
            <table style={{ borderCollapse: 'collapse', width: '100%' }}>
              <thead>
                <tr style={{ backgroundColor: '#f0f0f0', borderBottom: '2px solid #ccc' }}>
                  <th style={{ border: '1px solid #ccc', padding: '8px' }}>STT</th>
                  <th style={{ border: '1px solid #ccc', padding: '8px' }}>TaskID</th>
                  <th style={{ border: '1px solid #ccc', padding: '8px' }}>Description</th>
                  <th style={{ border: '1px solid #ccc', padding: '8px' }}>Status</th>
                  <th style={{ border: '1px solid #ccc', padding: '8px' }}>% Completion</th>
                  <th style={{ border: '1px solid #ccc', padding: '8px' }}>Comment</th>
                  <th style={{ border: '1px solid #ccc', padding: '8px' }}>Start Date</th>
                  <th style={{ border: '1px solid #ccc', padding: '8px' }}>Completion Date</th>
                </tr>
              </thead>
              <tbody>
                {filteredTasks.map((task, index) => (
                  <tr key={task.id} style={{ borderBottom: '1px solid #ddd' }}>
                    <td style={{ border: '1px solid #ccc', padding: '8px' }}>{index + 1}</td>
                    <td style={{ border: '1px solid #ccc', padding: '8px' }}>{task.taskId}</td>
                    <td style={{ border: '1px solid #ccc', padding: '8px' }}>{task.description}</td>
                    <td style={{ border: '1px solid #ccc', padding: '8px' }}>{task.status}</td>
                    <td style={{ border: '1px solid #ccc', padding: '8px', textAlign: 'center' }}>
                      {task.completionPercentage || 0}%
                    </td>
                    <td style={{ border: '1px solid #ccc', padding: '8px', fontSize: '12px' }}>
                      {task.comments?.join(' | ') || ''}
                    </td>
                    <td style={{ border: '1px solid #ccc', padding: '8px' }}>
                      {task.startDate ? new Date(task.startDate).toLocaleDateString('vi-VN') : ''}
                    </td>
                    <td style={{ border: '1px solid #ccc', padding: '8px' }}>
                      {task.completionDate ? new Date(task.completionDate).toLocaleDateString('vi-VN') : ''}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {/* Export Button */}
      <button
        onClick={handleExport}
        disabled={filteredTasks.length === 0}
        style={{
          padding: '10px 20px',
          backgroundColor: '#4CAF50',
          color: 'white',
          border: 'none',
          borderRadius: '4px',
          cursor: 'pointer',
          fontSize: '16px',
        }}
      >
        Export to Excel
      </button>
    </div>
  );
};

export default PersonalReportPage;
```

---

### 2.3) Cập nhật ReportPage: Thêm nút dẫn tới Personal Report

**File: `client/components/report/ReportPage.tsx`**

```typescript
// Thay card "Báo cáo cá nhân" bằng nút dẫn
import { Link } from 'react-router-dom';

const ReportPage: React.FC = () => {
  return (
    <div>
      <h1>Reports</h1>
      <div style={{ marginBottom: '20px' }}>
        <Link to="/reports/personal">
          <button style={{ padding: '10px 20px', backgroundColor: '#2196F3', color: 'white', border: 'none', borderRadius: '4px' }}>
            Báo Cáo Cá Nhân (Handover)
          </button>
        </Link>
      </div>
      {/* Các report khác... */}
    </div>
  );
};

export default ReportPage;
```

---

### 2.4) Cập nhật Routes

**File: `client/App.tsx`**

```typescript
import PersonalReportPage from './components/report/PersonalReportPage';

const App: React.FC = () => {
  return (
    <BrowserRouter>
      <Routes>
        {/* ... existing routes ... */}
        <Route path="/reports" element={<ReportPage />} />
        <Route path="/reports/personal" element={<PersonalReportPage />} /> {/* Thêm route này */}
        {/* ... */}
      </Routes>
    </BrowserRouter>
  );
};
```

---

### 2.5) Cập nhật Types (nếu chưa có)

**File: `client/types.ts`**

Đảm bảo `Task` có các trường cần thiết:
```typescript
interface Task {
  id: string;
  taskId: string;
  description: string;
  status: Status;
  createdAt: string;
  startDate?: string;
  completionDate?: string;
  completionPercentage?: number;
  comments?: string[];
  assignedResourceIds?: string[]; // Thêm nếu chưa có
  // ... other fields
}
```

---

### 2.6) Cài đặt Dependencies

**File: `client/package.json`**

Thêm `xlsx`:
```json
{
  "dependencies": {
    "xlsx": "^0.18.5",
    // ... other deps
  }
}
```

---

## 3) Các bước triển khai

### Bước 1: Cập nhật code trên máy dev
```bash
cd client

# Cài package mới
npm install

# Kiểm tra build
npm run build
```

### Bước 2: Commit & push
```bash
git add .
git commit -m "feat: add personal handover report with export to Excel"
git push origin main
```

### Bước 3: Server tự động pull & deploy
```bash
# Trên server, auto-pull (cron) hoặc manual:
cd /opt/jiraboard
git pull origin main
./scripts/deploy.sh pull

# Hoặc systemd restart
sudo systemctl restart jiraboard.service
```

### Bước 4: Kiểm tra
- Truy cập: `http://server-ip/#/reports`
- Klik "Báo Cáo Cá Nhân (Handover)" → đến trang `/reports/personal`
- Chọn khoảng ngày, xem preview, export Excel.

---

## 4) Lưu ý & Cân nhắc

| Điểm | Chi tiết |
|------|---------|
| **currentUserId** | Lưu từ response login; đảm bảo có giá trị trước khi render PersonalReportPage |
| **assignedResourceIds** | Task phải có trường này để lọc; nếu chưa, update schema Prisma & migrate |
| **completionDate** | Nếu task chưa xong, fallback về createdAt hoặc startDate |
| **localStorage** | Lưu filter để giữ lựa chọn khi F5 |
| **XLSX format** | Cột rộng & tiêu đề rõ ràng để export dễ đọc |
| **Empty state** | Hiển thị message khi không có task trong khoảng ngày |

---

## 5) Files cần sửa đổi

- ✅ `client/context/DataContext.tsx` — Thêm `currentUserId`
- ✅ `client/components/report/PersonalReportPage.tsx` — Trang báo cáo mới (new file)
- ✅ `client/components/report/ReportPage.tsx` — Thêm nút "Báo Cáo Cá Nhân"
- ✅ `client/App.tsx` — Thêm route `/reports/personal`
- ✅ `client/types.ts` — Đảm bảo Task có các trường cần thiết
- ✅ `client/package.json` — Thêm `xlsx` dependency

---

## 6) Build & Deploy

```bash
# Dev machine
cd client
npm install
npm run build
cd ..

# Push git
git add .
git commit -m "feat: personal handover report"
git push origin main

# Server auto-pulls & deploys via cron/webhook
# docker compose pull & up -d (do scripts/deploy.sh)
```

---

## Tóm tắt

Tính năng báo cáo cá nhân cho phép user xem các task được assign cho họ trong khoảng thời gian nhất định, preview dữ liệu, và export thành file Excel để handover. Chỉ xuất task của user đang login, không lộ data của user khác.
