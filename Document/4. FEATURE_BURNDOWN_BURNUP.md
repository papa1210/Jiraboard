# Burndown & Burnup – Log Hours, Scope Change, Reports

## Trước (BEFORE)
- Burndown trên Dashboard tính trực tiếp từ danh sách task (không API riêng) theo năm/tháng chọn.  
- Nguồn dữ liệu: `visibleTasks = tasks.filter(task => task.year === selectedYear && task.month === selectedMonth)`.  
- Tổng scope: cộng `estimatedHours`; nếu thiếu mặc định 1.  
- `workDate` là ngày hiện tại; mỗi ngày cộng dồn `actualHours` sau 23h59.  
- `completedByDay`: gộp `actualHours` (>0) của task vào `workDate`; nếu 0/thiếu thì không tính.  
- `cumulativeCompleted`: lũy kế `completedByDay`.  
- `remaining` mỗi ngày: `scope - cumulativeCompleted[day]` (không âm).  
- `idealRemaining`: đường thẳng từ scope về 0 trong `dayCount`.  
- Burndown vẽ `remaining` (xanh) vs `idealRemaining` (xám đứt).  
- Burnup reuse dữ liệu: `completed` (lũy kế) và `scope` cố định.  
- Nếu estimated/actualHours không nhập, task tính 1 điểm; nếu actualHours luôn 0 thì đường remaining không giảm.

## Sau (AFTER) – Log Hours theo ngày + báo cáo
- Backend  
  - Prisma: thêm model `TaskActualLog` (taskId/date/hours, unique task+date).  
  - API:  
    - `POST /tasks/:id/log-hours` (auth, task:update): upsert log theo ngày, cập nhật `task.actualHours`, trả task cập nhật.  
    - `GET /reports/actual-hours?month=YYYY-MM`: trả `labels (dd/mm)`, `completedByDay` (tổng giờ log theo ngày).
- Frontend  
  - TaskForm: ô “Actual Hours” read-only; thêm “Log actual hours (today)” khi edit; submit gọi log-hours (ngày hôm nay), form scrollable.  
  - Dashboard burndown/burnup: scope từ `estimatedHours`, `completedByDay` lấy từ `/reports/actual-hours`, lũy kế để tính remaining/burnup.  
  - Monthly report burndown/burnup: tương tự.  
  - API client: thêm `tasksApi.logHours`, `reportsApi.actualHours`.  
  - DataContext: thêm `logActualHours`.
- Migration cần:  
  - Dev: `docker compose -f docker-compose.dev.yml run --rm api npx prisma migrate dev --name add_task_actual_log`  
  - Prod: `docker compose -f docker-compose.prod.yml run --rm api npx prisma migrate deploy`  
  - Rebuild/restart API sau migrate.
- Files chính: `server/prisma/schema.prisma`, `server/src/index.ts`, `client/api.ts`, `client/context/DataContext.tsx`, `client/components/shared/TaskForm.tsx`, `client/components/dashboard/DashboardPage.tsx`, `client/components/report/MonthlyReportPage.tsx`.

## Scope Change – Burndown/Burnup & User Log Hours
- Backend  
  - Prisma: thêm `TaskScopeLog` (deltaHours, date, createdById), quan hệ `createdBy/scopeLogs`.  
  - Khi tạo task: log scope delta = `estimatedHours` (mặc định 1).  
  - Khi update task: nếu `estimatedHours` đổi, log delta `(new - old)` với user hiện tại.  
  - `POST /tasks/:id/log-hours` đặt `createdById`.  
  - `GET /tasks/:id/log-hours?date=YYYY-MM-DD` trả giờ của ngày đó.  
  - `GET /reports/scope?month=YYYY-MM` trả `labels`, `scopeByDay`, `changes (day, value, delta)`.
- Frontend  
  - TaskForm: chọn ngày khi log actual hours; load giờ đã log cho ngày chọn, override nếu nhập mới.  
  - API client: `reportsApi.scope`, `tasksApi.getLogHours`.  
  - DataContext: thêm `getLogHours`.  
  - Dashboard & Monthly: fetch scope report; burndown/burnup dùng `scopeByDay` (remaining = scopeByDay - cumulativeCompleted); hiển thị scope change bằng chấm tím (ReferenceDot).  
  - Build OK (`npm run build`).
- Migration cần:  
  - Dev: `docker compose -f docker-compose.dev.yml run --rm api npx prisma migrate dev --name add_scope_log`  
  - Prod: `docker compose -f docker-compose.prod.yml run --rm api npx prisma migrate deploy`  
  - Restart API nếu cần.
- Sau migrate: reload Dashboard/Monthly để thấy chấm scope change; TaskForm hiển thị giờ đã log của ngày chọn (0 nếu chưa có).
