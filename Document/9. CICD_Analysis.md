# 1) Tổng quan kiến trúc workflow

- Sự kiện kích hoạt:
  - on: push vào nhánh main;
  - on: workflow_dispatch để chạy thủ công. [biendongpo...epoint.com]
- Job chính: build-and-push (chạy trên ubuntu-latest). [biendongpo...epoint.com]
- Biến môi trường (env):
  - REGISTRY lấy từ secrets.REGISTRY (ví dụ: ghcr.io/your-org hoặc docker.io/your-user).
  - API_IMAGE = ${{ secrets.REGISTRY }}/jira-api
  - CLIENT_IMAGE = ${{ secrets.REGISTRY }}/jira-client
  - => Hai biến ảnh chỉ ra tên repo image cho API và Client. [biendongpo...epoint.com]
- Các bước chính:
  - Checkout mã nguồn (actions/checkout@v4).
  - Set up QEMU (docker/setup-qemu-action@v2)—phục vụ build multi-arch.
  - Set up Buildx (docker/setup-buildx-action@v2).
  - Login vào registry (docker/login-action@v2) dùng secrets.REGISTRY_HOST, secrets.REGISTRY_USERNAME, secrets.REGISTRY_PASSWORD.
  - Build & push image API (từ Dockerfile.api) với tag latest và github.sha.
  - Build & push image Client (từ Dockerfile.client) với tag latest và github.sha.
  - Gọi webhook triển khai nếu có secrets.DEPLOY_WEBHOOK_URL.
  - In ra output tên/tag của 2 images vừa push. [biendongpo...epoint.com]

# 2) Luồng hoạt động chi tiết từng bước

- Checkout repo: Lấy mã nguồn hiện tại để build. [biendongpo...epoint.com]
- Thiết lập QEMU: Cho phép giả lập kiến trúc CPU khác (ví dụ build cho arm64 trên runner x86). Lưu ý: Hiện workflow chưa khai báo platforms trong bước build, nên mặc dù bật QEMU, bạn vẫn đang build theo kiến trúc mặc định của runner trừ khi thêm platforms:. [biendongpo...epoint.com]
- Thiết lập Buildx: Bổ trợ build đa nền tảng và cache. [biendongpo...epoint.com]
- Đăng nhập registry: Dựa vào REGISTRY_HOST, REGISTRY_USERNAME, REGISTRY_PASSWORD—giúp push được ảnh. [biendongpo...epoint.com]
- Build & push API:
  - context: . (root repo)
  - file: Dockerfile.api
  - push: true
  - tags: gồm latest và commit SHA (${{ github.sha }}) ⇒ tạo tính truy vết build. [biendongpo...epoint.com]
- Build & push Client: tương tự API nhưng dùng Dockerfile.client; tag latest + SHA. [biendongpo...epoint.com]
- Trigger deploy webhook (optional): Nếu DEPLOY_WEBHOOK_URL có giá trị, workflow POST JSON chứa ref: "main" và danh sách images kèm SHA đến URL đó. [biendongpo...epoint.com]
- Outputs: Echo ra tên đầy đủ của hai images đã đẩy. [biendongpo...epoint.com]

# 3) Những bí mật/secrets yêu cầu & ý nghĩa

- REGISTRY (ví dụ: ghcr.io/<org> hoặc docker.io/<user>) → dùng để compose tên image. [biendongpo...epoint.com]
- REGISTRY_HOST (ví dụ: ghcr.io hoặc docker.io) → dùng cho bước đăng nhập registry. [biendongpo...epoint.com]
- REGISTRY_USERNAME, REGISTRY_PASSWORD → thông tin đăng nhập để push ảnh. [biendongpo...epoint.com]
- DEPLOY_WEBHOOK_URL (tùy chọn) → endpoint triển khai môi trường downstream. [biendongpo...epoint.com]
- Tip: Với GitHub Container Registry (GHCR), bạn có thể thay REGISTRY_PASSWORD bằng PAT có scope write:packages, hoặc dùng OIDC + workload identity nếu registry hỗ trợ (bảo mật hơn). (Đây là khuyến nghị tổng quát; file hiện tại dùng username/password.) [biendongpo...epoint.com]

# 4) Điểm mạnh

- Đơn giản & rõ ràng: Một job duy nhất, dễ hiểu và quản lý. [biendongpo...epoint.com]
- Tag theo SHA: Giúp truy vết và rollback dễ hơn so với chỉ latest. [biendongpo...epoint.com]
- Webhook triển khai: Tách build/push khỏi triển khai thực tế, linh hoạt với nhiều nền tảng (K8s, Swarm, VM…). [biendongpo...epoint.com]

# 5) Rủi ro/điểm cần cải thiện

- QEMU bật nhưng chưa build multi-arch  
  - Chưa có platforms: linux/amd64,linux/arm64 → nếu bạn cần image chạy trên ARM (Raspberry Pi, Graviton) thì hiện chưa đảm bảo. [biendongpo...epoint.com]
- Thiếu kiểm thử trước khi build/push  
  - Comment gợi ý “optional: run tests/lint” nhưng chưa có job chạy test/lint → rủi ro push image lỗi lên registry. [biendongpo...epoint.com]
- Bảo mật secrets  
  - Dùng username/password cho registry: cân nhắc chuyển sang OIDC (nếu hỗ trợ) hoặc PAT với scope tối thiểu.  
  - Webhook: hiện gửi thẳng bằng curl không có chữ ký (HMAC) hoặc token xác thực trong header—dễ bị lạm dụng nếu URL lộ. [biendongpo...epoint.com]
- Tagging chiến lược  
  - Mới có latest + sha: nên cân nhắc thêm tag theo version hoặc branch (ví dụ: main, release-2025.12, v1.2.3) để phục vụ môi trường staging/prod. [biendongpo...epoint.com]
- Cache build  
  - Chưa cấu hình cache-from / cache-to → build mỗi lần sẽ lâu hơn. [biendongpo...epoint.com]
- Phân tách trách nhiệm  
  - Build API/Client cùng một job: nếu một cái fail, cả job fail. Có thể tách thành matrix job hoặc hai jobs độc lập để tăng song song & rõ ràng. [biendongpo...epoint.com]
- Quản trị môi trường triển khai  
  - Webhook gửi ref: "main" cố định; nếu sau này mở rộng cho nhiều nhánh/môi trường, nên gửi thêm branch, commit, tags và metadata (service name, version). [biendongpo...epoint.com]

# 6) Đề xuất cải tiến (kèm mẫu YAML)

(A) Thêm job Test/Lint trước khi build  
- Chạy unit tests/lint, chỉ khi pass mới build & push.  
- Dùng needs: test để gate build. [biendongpo...epoint.com]

(B) Bật multi-arch khi cần  
- Khai báo platforms: linux/amd64,linux/arm64. [biendongpo...epoint.com]

(C) Dùng build cache  
- cache-from/cache-to với type=gha để tận dụng cache của GitHub Actions. [biendongpo...epoint.com]

(D) Bảo mật webhook  
- Thêm header token (ví dụ X-Deploy-Token: ${{ secrets.DEPLOY_TOKEN }}) hoặc HMAC signature để xác thực. [biendongpo...epoint.com]

(E) Tag theo nhánh/phiên bản  
- Thêm tag: branch (normalize), date, hoặc semver nếu bạn có release pipeline. [biendongpo...epoint.com]

Mẫu YAML tham khảo:
```
name: CI/CD – Build, Push Images and Trigger Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # 1) Test/Lint trước khi build
  test:
    name: Run Tests & Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Setup Node (ví dụ nếu client là JS)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps (api/client)
        run: |
          echo "Chạy cài đặt & kiểm thử tùy dự án của bạn"
          # ví dụ:
          # cd api && npm ci && npm test
          # cd ../client && npm ci && npm run lint
      # nếu là Python/Go/.NET, thay bước cho phù hợp

  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: test
    env:
      REGISTRY: ${{ secrets.REGISTRY }}           # e.g. ghcr.io/your-org
      API_IMAGE: ${{ secrets.REGISTRY }}/jira-api
      CLIENT_IMAGE: ${{ secrets.REGISTRY }}/jira-client
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.REGISTRY_HOST }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Compute tags
        id: tags
        run: |
          BRANCH="${GITHUB_REF##*/}"
          BRANCH_TAG=$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]-_.')
          echo "branch_tag=$BRANCH_TAG" >> "$GITHUB_OUTPUT"
          echo "sha_tag=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - name: Build & push API image (multi-arch + cache)
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile.api
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.API_IMAGE }}:latest
            ${{ env.API_IMAGE }}:${{ steps.tags.outputs.branch_tag }}
            ${{ env.API_IMAGE }}:${{ steps.tags.outputs.sha_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true # ghi metadata build (nếu cần)

      - name: Build & push Client image (multi-arch + cache)
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile.client
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.CLIENT_IMAGE }}:latest
            ${{ env.CLIENT_IMAGE }}:${{ steps.tags.outputs.branch_tag }}
            ${{ env.CLIENT_IMAGE }}:${{ steps.tags.outputs.sha_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true

      - name: Trigger deploy webhook (secure)
        if: ${{ secrets.DEPLOY_WEBHOOK_URL != '' }}
        run: |
          echo "Calling deploy webhook..."
          payload='{"ref":"'"${GITHUB_REF##*/}"'","commit":"'"${GITHUB_SHA}"'","images":["'${{ env.API_IMAGE }}':'${{ steps.tags.outputs.sha_tag }}'","'${{ env.CLIENT_IMAGE }}':'${{ steps.tags.outputs.sha_tag }}'"]}'
          curl -sSf -X POST \
            -H "Content-Type: application/json" \
            -H "X-Deploy-Token: ${{ secrets.DEPLOY_TOKEN }}" \
            -d "$payload" \
            ${{ secrets.DEPLOY_WEBHOOK_URL }}

      - name: Outputs
        run: |
          echo "API image:   ${{ env.API_IMAGE }}:${{ steps.tags.outputs.sha_tag }}"
          echo "CLIENT image: ${{ env.CLIENT_IMAGE }}:${{ steps.tags.outputs.sha_tag }}"
```
- Lưu ý: Phần test bạn thay bằng công cụ/ngôn ngữ thực tế (Node/Python/.NET/Go…). Phần `provenance: true` giúp gắn siêu dữ liệu build (SBOM/SLSA), có thể tắt nếu chưa cần. [biendongpo...epoint.com]

7) Checklist thiết lập để chạy thành công

- Tạo các Secrets trong repo/org:
  - REGISTRY, REGISTRY_HOST, REGISTRY_USERNAME, REGISTRY_PASSWORD
  - (tùy chọn) DEPLOY_WEBHOOK_URL, DEPLOY_TOKEN (nếu bật bảo mật webhook). [biendongpo...epoint.com]
- Đảm bảo có Dockerfile.api và Dockerfile.client ở root repo. [biendongpo...epoint.com]
- Quyền push đúng với registry (GHCR/Docker Hub). [biendongpo...epoint.com]
- Endpoint webhook sẵn sàng nhận JSON, có cơ chế xác thực. [biendongpo...epoint.com]
